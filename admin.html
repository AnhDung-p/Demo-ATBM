<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Trang qu·∫£n tr·ªã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="index.html">Trang qu·∫£n tr·ªã</a>
      <div class="ms-auto d-flex gap-2">
        <!-- ‚ùå X√≥a n√∫t ƒëƒÉng nh·∫≠p / ƒëƒÉng k√Ω -->
        <button id="logoutBtn" class="btn btn-outline-danger">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <div class="p-5 bg-white rounded-4 shadow-sm text-center mb-4">
      <h2 class="mb-2">Xin ch√†o, <span id="displayName">Admin</span></h2>
      <p class="text-muted mb-0">B·∫£ng ƒëi·ªÅu khi·ªÉn qu·∫£n tr·ªã h·ªá th·ªëng x√°c th·ª±c danh t√≠nh</p>
    </div>

    <!-- üü¢ L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p -->
    <div id="historyCard" class="card shadow-sm rounded-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p to√†n h·ªá th·ªëng</h5>
          <div class="d-flex gap-2">
            <input id="filterAddr" class="form-control form-control-sm" style="width:260px"
                   placeholder="L·ªçc theo ƒë·ªãa ch·ªâ v√≠ (0x...)"/>
            <button id="btnRefresh" class="btn btn-sm btn-outline-success">L√†m m·ªõi</button>
          </div>
        </div>

        <div class="table-responsive">
        <a class="btn btn-outline-success" href="admin-users.html">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
          <table class="table table-sm align-middle" id="historyTable">
            <thead class="table-light">
              <tr>
                <th style="width:60px">#</th>
                <th>ƒê·ªãa ch·ªâ v√≠</th>
                <th>Th·ªùi gian (gi·ªù VN)</th>
                <th>IP</th>
                <th>User Agent</th>
                <th>Context</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">ƒêang t·∫£i‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

<script type="module">
  import { getCurrentUser, clearCurrentUser, SERVER_URL, shortAddr } from "./web3.js";

  const user = getCurrentUser();
  const nameEl = document.getElementById('displayName');
  const logoutBtn = document.getElementById('logoutBtn');
  const historyCard = document.getElementById('historyCard');

  // üß© Ki·ªÉm tra quy·ªÅn admin
  if (!user || user.role !== 'admin') {
    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã!");
    window.location.href = "index.html";
  }

  // C·∫≠p nh·∫≠t t√™n
  if (user) nameEl.textContent = user.fullname || shortAddr(user.wallet);

  // ƒêƒÉng xu·∫•t
  logoutBtn?.addEventListener('click', () => {
    clearCurrentUser();
    window.location.href = "login.html";
  });

  // ====== Load l·ªãch s·ª≠ ƒëƒÉng nh·∫≠p ======
  startHistoryLoading();

  function startHistoryLoading() {
    const TABLE_BODY  = document.querySelector("#historyTable tbody");
    const INPUT_ADDR  = document.querySelector("#filterAddr");
    const BTN_REFRESH = document.querySelector("#btnRefresh");

    const fmtVN = (iso) => {
      try {
        const d = new Date(iso);
        return new Intl.DateTimeFormat("vi-VN", {
          dateStyle: "short", timeStyle: "medium", timeZone: "Asia/Ho_Chi_Minh"
        }).format(d);
      } catch { return iso; }
    };
    const shortUA = (ua) => ua ? (ua.length > 120 ? ua.slice(0,117)+"‚Ä¶" : ua) : "";
    const shortA  = (a) => a ? (a.slice(0,6)+"‚Ä¶"+a.slice(-4)) : "";

    async function loadHistory() {
      try {
        const addr = (INPUT_ADDR?.value || "").trim();
        const qs = new URLSearchParams({ limit: "300" });
        if (addr) qs.set("address", addr);

        const res = await fetch(`${SERVER_URL}/api/login-history?${qs.toString()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const items = (data.items || []).slice().reverse();
        TABLE_BODY.innerHTML = items.length
          ? ""
          : `<tr><td colspan="6" class="text-muted">Ch∆∞a c√≥ l∆∞·ª£t ƒëƒÉng nh·∫≠p n√†o.</td></tr>`;

        items.forEach((it, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td><span class="text-danger-emphasis" title="${it.address}">${shortA(it.address)}</span></td>
            <td>${fmtVN(it.time)}</td>
            <td>${it.ip || ""}</td>
            <td title="${(it.userAgent||"").replace(/"/g,'&quot;')}">${shortUA(it.userAgent||"")}</td>
            <td>${it.context ?? ""}</td>
          `;
          TABLE_BODY.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        TABLE_BODY.innerHTML = `<tr><td colspan="6" class="text-danger">T·∫£i l·ªãch s·ª≠ th·∫•t b·∫°i: ${e.message}</td></tr>`;
      }
    }

    BTN_REFRESH?.addEventListener("click", () => {
      // X√≥a n·ªôi dung trong √¥ t√¨m ki·∫øm
      if (INPUT_ADDR) INPUT_ADDR.value = "";

      // G·ªçi l·∫°i h√†m loadHistory ƒë·ªÉ t·∫£i l·∫°i to√†n b·ªô danh s√°ch
      loadHistory();
    });
    INPUT_ADDR?.addEventListener("keydown", (e) => { if (e.key === "Enter") loadHistory(); });

    loadHistory();
    setInterval(loadHistory, 60000); // refresh m·ªói 60s
  }
</script>
</body>
</html>
