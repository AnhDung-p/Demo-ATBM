<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Quản lý người dùng (localStorage)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="index.html">Quản lý người dùng</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-success" href="admin.html">Trang quản trị</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">Danh sách tài khoản đã đăng ký</h5>
      <div class="d-flex gap-2">
        <input id="searchBox" class="form-control form-control-sm" placeholder="Tìm theo tên" style="width:260px">
        <button id="btnRefresh" class="btn btn-sm btn-outline-success">Làm mới</button>
      </div>
    </div>

    <div class="card shadow-sm rounded-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle" id="usersTable">
            <thead class="table-light">
              <tr>
                <th style="width:60px">#</th>
                <th>Địa chỉ ví</th>
                <th>Tên hiển thị</th>
                <th style="width:140px">Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="text-muted">Đang tải…</td></tr>
            </tbody>
          </table>
        </div>
        <small id="summary" class="text-muted"></small>
      </div>
    </div>
  </main>

<script type="module">
  import { getProfiles, setProfiles, shortAddr } from "./web3.js";

  const TBody      = document.querySelector("#usersTable tbody");
  const Summary    = document.querySelector("#summary");
  const BtnRefresh = document.querySelector("#btnRefresh");
  const SearchBox  = document.querySelector("#searchBox");

  function toArray(profilesObj) {
    return Object.entries(profilesObj || {}).map(([wallet, profile]) => ({
      wallet,
      fullname: profile?.fullname || ""
    }));
  }

  function render() {
    const filter = (SearchBox.value || "").trim().toLowerCase();
    const profilesObj = getProfiles();
    let rows = toArray(profilesObj);

    // chỉ lọc theo tên
    if (filter) {
      rows = rows.filter(r => (r.fullname || "").toLowerCase().includes(filter));
    }

    rows.sort((a,b) => (a.fullname||"").localeCompare(b.fullname||"") || a.wallet.localeCompare(b.wallet));
    TBody.innerHTML = rows.length ? "" : `<tr><td colspan="4" class="text-muted">Chưa có người dùng.</td></tr>`;

    rows.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td title="${r.wallet}">${shortAddr(r.wallet)}</td>
        <td>${escapeHtml(r.fullname)}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" data-act="rename" data-wallet="${r.wallet}">Đổi tên</button>
        </td>
      `;
      TBody.appendChild(tr);
    });

    Summary.textContent = `Tổng có: ${rows.length} tài khoản`;
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // Chỉ còn thao tác "Đổi tên"
  TBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act='rename']");
    if (!btn) return;
    const wallet = btn.getAttribute("data-wallet");
    const profilesObj = getProfiles();
    const current = profilesObj[wallet]?.fullname || "";
    const name = prompt("Nhập tên hiển thị mới:", current);
    if (name === null) return;
    profilesObj[wallet] = { ...(profilesObj[wallet]||{}), fullname: name.trim() };
    setProfiles(profilesObj);
    render();
  });

  // Làm mới
  BtnRefresh.addEventListener("click", () => {
    SearchBox.value = "";
    render();
  });

  // Tìm kiếm theo tên
  SearchBox.addEventListener("input", render);
  SearchBox.addEventListener("keydown", (e)=>{ if(e.key==="Enter") render(); });


  // Khởi tạo
  render();

</script>
</body>
</html>
