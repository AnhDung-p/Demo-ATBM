<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>ÄÄƒng kÃ½ (Wallet only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="mx-auto card shadow-sm rounded-4" style="max-width:720px">
      <div class="card-body p-4 p-md-5">
        <h3 class="mb-1">ÄÄƒng kÃ½ on-chain</h3>
        <p class="text-muted">B1: Káº¿t ná»‘i vÃ­ â†’ B2: Chá»n tÃªn hiá»ƒn thá»‹ â†’ B3: ÄÄƒng kÃ½</p>

        <div class="mb-3 d-flex align-items-center gap-2">
          <button type="button" id="btnConnect" class="btn btn-outline-success">Káº¿t ná»‘i vÃ­</button>
          <small>Äá»‹a chá»‰ vÃ­: <span id="walletAddr" class="text-muted">â€”</span></small>
        </div>

        <form id="registerForm" class="row g-3 needs-validation" novalidate>
          <div class="col-md-8">
            <label class="form-label" for="fullname">TÃªn hiá»ƒn thá»‹</label>
            <input id="fullname" type="text" class="form-control" placeholder="VÃ­ dá»¥: Phan Anh DÅ©ng" required />
            <div class="invalid-feedback">Vui lÃ²ng nháº­p tÃªn hiá»ƒn thá»‹.</div>
          </div>
          <div class="col-12 d-grid d-md-flex gap-2">
            <button class="btn btn-success px-4" type="submit">ÄÄƒng kÃ½ on-chain</button>
            <a class="btn btn-outline-secondary" href="login.html">ÄÃ£ cÃ³ vÃ­? ÄÄƒng nháº­p</a>
          </div>
        </form>

        <!-- ğŸŸ¢ PHáº¦N THÃŠM Má»šI: vÃ¹ng hiá»ƒn thá»‹ tráº¡ng thÃ¡i -->
        <div id="statusMsg" class="mt-3 text-center text-muted"></div>
        <!-- ğŸ”´ Háº¾T PHáº¦N THÃŠM Má»šI -->
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js"></script>
<script type="module">
  import {
    connectWallet,
    registerWalletOnly,
    setProfile,
    setCurrentUser,
    shortAddr,
    loginWithSignature
  } from "./web3.js"; // Ä‘Ã£ import loginWithSignature

  let currentWallet = "";
  const msg = document.getElementById("statusMsg") || (() => {
    const d = document.createElement("div");
    d.id = "statusMsg";
    d.className = "mt-3 text-center text-muted";
    document.querySelector(".card-body").appendChild(d);
    return d;
  })();
  const btnConnect = document.getElementById("btnConnect");
  const form = document.getElementById("registerForm");
  const submitBtn = form.querySelector('button[type="submit"]');

  btnConnect.onclick = async () => {
    try {
      currentWallet = await connectWallet();
      document.getElementById("walletAddr").textContent = currentWallet || "â€”";
      msg.textContent = "âœ… ÄÃ£ káº¿t ná»‘i vÃ­: " + shortAddr(currentWallet);
    } catch (e) {
      console.error(e);
      alert(e?.message || e);
    }
  };

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (!currentWallet) { alert("Vui lÃ²ng káº¿t ná»‘i vÃ­ trÆ°á»›c."); return; }

    const fullname = document.getElementById("fullname").value.trim();
    if (!fullname) { form.classList.add("was-validated"); return; }

    try {
      // Disable nÃºt Ä‘á»ƒ trÃ¡nh báº¥m nhiá»u láº§n
      submitBtn.disabled = true;
      submitBtn.innerText = "Äang Ä‘Äƒng kÃ½â€¦";
      msg.textContent = "â³ Äang gá»­i giao dá»‹ch Ä‘Äƒng kÃ½ lÃªn blockchain...";

      // 1) Gá»­i tx register(...)
      await registerWalletOnly();

      // 2) LÆ°u há»“ sÆ¡ hiá»ƒn thá»‹
      setProfile(currentWallet, { fullname });
      setCurrentUser({ wallet: currentWallet.toLowerCase(), fullname });

      msg.textContent = "âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! Äang xÃ¡c thá»±c Ä‘Äƒng nháº­pâ€¦";

      // 3) KÃ½ nonce + verify server (ghi lá»‹ch sá»­)
      const r = await loginWithSignature("after-register");

      if (r.ok) {
        // ğŸ‘‰ Chuyá»ƒn hÆ°á»›ng NGAY, khÃ´ng setTimeout, khÃ´ng alert
        // DÃ¹ng replace Ä‘á»ƒ trÃ¡nh quay láº¡i trang Ä‘Äƒng kÃ½ khi Back
        window.location.replace("./index.html"); // Ä‘áº£m báº£o cÃ¹ng origin
        return;
      } else {
        msg.textContent = "âš ï¸ ÄÄƒng kÃ½ xong nhÆ°ng Ä‘Äƒng nháº­p tá»± Ä‘á»™ng tháº¥t báº¡i: " + r.error;
        submitBtn.disabled = false;
        submitBtn.innerText = "ÄÄƒng kÃ½ on-chain";
      }
    } catch (e) {
      console.error(e);
      msg.textContent = "âŒ Lá»—i: " + (e?.reason || e?.message || e);
      submitBtn.disabled = false;
      submitBtn.innerText = "ÄÄƒng kÃ½ on-chain";
    }
  });
</script>
</body>
</html>
