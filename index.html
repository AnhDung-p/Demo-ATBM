<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Trang chá»§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="index.html">XÃ¡c minh danh tÃ­nh</a>
      <div class="ms-auto d-flex gap-2">
        <a id="loginLink" class="btn btn-outline-success" href="login.html">ÄÄƒng nháº­p</a>
        <a id="registerLink" class="btn btn-success" href="register.html">ÄÄƒng kÃ½</a>
        <button id="logoutBtn" class="btn btn-outline-danger d-none">ÄÄƒng xuáº¥t</button>
        <!-- <a id="admin" class="btn btn-success" href="admin.html">Admin</a> -->
         <button id="btnAdmin" class="btn btn-outline-warning  d-none">Trang quáº£n trá»‹</button>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <div class="p-5 bg-white rounded-4 shadow-sm text-center">
      <h2 class="mb-3">Xin chÃ o, <span id="displayName">KhÃ¡ch</span> </h2>
      <p class="text-muted mb-4">Trang chá»§</p>
      <div id="ctaArea">
        <a href="login.html" class="btn btn-success me-2">ÄÄƒng nháº­p</a>
        <a href="register.html" class="btn btn-outline-success">ÄÄƒng kÃ½</a>
      </div>
    </div>

    <!-- ğŸŸ¢ PHáº¦N THÃŠM Má»šI: Hiá»ƒn thá»‹ lá»‹ch sá»­ Ä‘Äƒng nháº­p -->
    <div id="historyCard" class="card shadow-sm rounded-4 my-4 d-none">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">Lá»‹ch sá»­ Ä‘Äƒng nháº­p</h5>
          <div class="d-flex gap-2">
            <input id="filterAddr" class="form-control form-control-sm" style="width:360px"disabled/>
            <button id="btnRefresh" class="btn btn-sm btn-outline-success">LÃ m má»›i</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle" id="historyTable">
            <thead class="table-light">
              <tr>
                <th style="width:60px">#</th>
                <th>Äá»‹a chá»‰ vÃ­</th>
                <th>Thá»i gian (giá» VN)</th>
                <th>IP</th>
                <th>User Agent</th>
                <th>Context</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">Äang táº£iâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ğŸ”´ Háº¾T PHáº¦N THÃŠM Má»šI -->
  </main>

<script type="module">
  import { getCurrentUser, clearCurrentUser, SERVER_URL, shortAddr } from "./web3.js";

  const user = getCurrentUser();
  const nameEl = document.getElementById('displayName');
  const cta = document.getElementById('ctaArea');
  const loginLink = document.getElementById('loginLink');
  const registerLink = document.getElementById('registerLink');
  const logoutBtn = document.getElementById('logoutBtn');

  // ğŸ‘‰ Card lá»‹ch sá»­
  const historyCard = document.getElementById('historyCard'); // ğŸŸ¢

  // UI theo tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
  if (user) {
    nameEl.textContent = user.fullname || shortAddr(user.wallet);
    cta.classList.add('d-none');
    loginLink.classList.add('d-none');
    registerLink.classList.add('d-none');
    logoutBtn.classList.remove('d-none');

    // ğŸŸ¢ Chá»‰ khi cÃ³ user má»›i hiá»‡n card & báº¯t Ä‘áº§u load lá»‹ch sá»­
    historyCard?.classList.remove('d-none');
    startHistoryLoading(user.wallet);
  } else {
    // ğŸŸ¢ Khi chÆ°a Ä‘Äƒng nháº­p: áº©n card & khÃ´ng load lá»‹ch sá»­
    historyCard?.classList.add('d-none');
  }

  logoutBtn?.addEventListener('click', () => {
    clearCurrentUser();
    window.location.reload();
  });

  // ====== Pháº§n lá»‹ch sá»­ (chá»‰ khá»Ÿi táº¡o khi Ä‘Äƒng nháº­p) ======
function startHistoryLoading(wallet) {
  const TABLE_BODY  = document.querySelector("#historyTable tbody");
  const INPUT_ADDR  = document.querySelector("#filterAddr");
  const BTN_REFRESH = document.querySelector("#btnRefresh");

  // ğŸŸ¢ Tá»° DÃN Ä‘á»‹a chá»‰ Ä‘ang Ä‘Äƒng nháº­p vÃ o Ã´ tÃ¬m kiáº¿m + khoÃ¡ sá»­a (tuá»³ chá»n)
  if (INPUT_ADDR) {
    INPUT_ADDR.value = wallet || "";
    // Náº¿u muá»‘n cho phÃ©p sá»­a, bá» dÃ²ng dÆ°á»›i
    // INPUT_ADDR.readOnly = true;
    INPUT_ADDR.title = "Äang hiá»ƒn thá»‹ lá»‹ch sá»­ cá»§a: " + (wallet || "");
  }

  const fmtVN  = (iso) => {
    try { return new Intl.DateTimeFormat("vi-VN", {dateStyle:"short", timeStyle:"medium", timeZone:"Asia/Ho_Chi_Minh"}).format(new Date(iso)); }
    catch { return iso; }
  };
  const shortUA = (ua) => ua ? (ua.length > 120 ? ua.slice(0,117)+"â€¦" : ua) : "";
  const shortA  = (a)  => a ? (a.slice(0,6)+"â€¦"+a.slice(-4)) : "";

  async function loadHistory() {
    try {
      // Láº¥y chuá»—i lá»c tá»« input (Ä‘Ã£ auto dÃ¡n vÃ­ hiá»‡n táº¡i)
      let addr = (INPUT_ADDR?.value || "").trim().toLowerCase().replace(/^0x/, "");

      // Láº¥y nhiá»u báº£n ghi rá»“i lá»c táº¡i client
      const qs  = new URLSearchParams({ limit: "1000" });
      const res = await fetch(`${SERVER_URL}/api/login-history?${qs.toString()}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      let items = (data.items || []).slice().reverse();

      // ğŸ” Chá»‰ giá»¯ cÃ¡c log cÃ³ address chá»©a chuá»—i nháº­p (máº·c Ä‘á»‹nh lÃ  vÃ­ cá»§a mÃ¬nh)
      if (addr) {
        items = items.filter(it =>
          (it.address || "").toLowerCase().replace(/^0x/, "").includes(addr)
        );
      }

      TABLE_BODY.innerHTML = items.length
        ? ""
        : `<tr><td colspan="6" class="text-muted">KhÃ´ng cÃ³ lá»‹ch sá»­ Ä‘Äƒng nháº­p.</td></tr>`;

      items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td><span class="text-danger-emphasis" title="${it.address}">${shortA(it.address)}</span></td>
          <td>${fmtVN(it.time)}</td>
          <td>${it.ip || ""}</td>
          <td title="${(it.userAgent||"").replace(/"/g,'&quot;')}">${shortUA(it.userAgent||"")}</td>
          <td>${it.context ?? ""}</td>
        `;
        TABLE_BODY.appendChild(tr);
      });
    } catch (e) {
      console.error(e);
      TABLE_BODY.innerHTML = `<tr><td colspan="6" class="text-danger">Táº£i lá»‹ch sá»­ tháº¥t báº¡i: ${e.message}</td></tr>`;
    }
  }

  // ğŸŸ¢ NÃºt "LÃ m má»›i": xoÃ¡ text (náº¿u báº¡n muá»‘n) rá»“i dÃ¡n láº¡i vÃ­ mÃ¬nh vÃ  load
  BTN_REFRESH?.addEventListener("click", () => {
    if (INPUT_ADDR) INPUT_ADDR.value = wallet || "";
    loadHistory();
  });

  // ğŸŸ¢ Tá»± load ngay khi vÃ o trang + auto refresh
  loadHistory();
  setInterval(loadHistory, 15000);

  // (Tuá»³ chá»n) Debounce khi gÃµ Ä‘á»ƒ tá»± lá»c
  let timer;
  INPUT_ADDR?.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(loadHistory, 300);
  });
}

const btnAdmin = document.getElementById("btnAdmin");

// ğŸ§© Náº¿u user lÃ  admin thÃ¬ hiá»‡n nÃºt, ngÆ°á»£c láº¡i áº©n Ä‘i
if (user && user.role === "admin") {
  btnAdmin?.classList.remove("d-none");
}

// // ğŸ§  Khi báº¥m nÃºt admin: kiá»ƒm tra quyá»n trÆ°á»›c khi chuyá»ƒn trang
// btnAdmin?.addEventListener("click", () => {
//   if (!user || user.role !== "admin") {
//     alert("Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p trang quáº£n trá»‹!");
//     return; // âŒ Dá»«ng luÃ´n, khÃ´ng chuyá»ƒn
//   }
//   // âœ… LÃ  admin â†’ cho phÃ©p chuyá»ƒn
//   window.location.href = "admin.html";
// });



</script>
</body>
</html>
